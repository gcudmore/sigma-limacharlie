detect:
  log type: wel
  op: and
  rules:
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: Event/System/EventID
        value: '4656'
      - case sensitive: false
        op: is
        path: Event/System/EventID
        value: '4663'
    - case sensitive: false
      op: is
      path: Event/EventData/ObjectType
      value: Key
    - case sensitive: false
      op: is
      path: Event/EventData/ObjectName
      value: \REGISTRY\MACHINE\SOFTWARE\Microsoft\Microsoft Online\Reporting\MonitoringAgent
  - not: true
    op: or
    rules:
    - case sensitive: false
      op: contains
      path: Event/EventData/ProcessName
      value: Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe
    - case sensitive: false
      op: contains
      path: Event/EventData/ProcessName
      value: Microsoft.Identity.Health.Adfs.InsightsService.exe
    - case sensitive: false
      op: contains
      path: Event/EventData/ProcessName
      value: Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe
    - case sensitive: false
      op: contains
      path: Event/EventData/ProcessName
      value: Microsoft.Identity.Health.Adfs.PshSurrogate.exe
    - case sensitive: false
      op: contains
      path: Event/EventData/ProcessName
      value: Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe
  target: log
respond:
- action: report
  metadata:
    author: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC
    description: 'This detection uses Windows security events to detect suspicious
      access attempts to the registry key of Azure AD Health monitoring agent.

      This detection requires an access control entry (ACE) on the system access control
      list (SACL) of the following securable object HKLM\SOFTWARE\Microsoft\Microsoft
      Online\Reporting\MonitoringAgent.

      '
    falsepositives:
    - Unknown
    level: medium
    references:
    - https://o365blog.com/post/hybridhealthagent/
    - https://github.com/OTRF/Set-AuditRule/blob/master/rules/registry/aad_connect_health_monitoring_agent.yml
    tags:
    - attack.discovery
    - attack.t1012
  name: Azure AD Health Monitoring Agent Registry Keys Access

