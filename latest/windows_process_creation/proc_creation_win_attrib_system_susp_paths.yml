detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: and
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \attrib.exe
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' +s'
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ' %'
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \Users\Public\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \AppData\Local\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \ProgramData\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \Downloads\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \Windows\Temp\
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: .bat
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: .ps1
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: .vbe
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: .vbs
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: .exe
    - not: true
      op: and
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Windows\TEMP\
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: .exe
respond:
- action: report
  metadata:
    author: Nasreddine Bencherchali
    description: Detects usage of attrib with "+s" option to set suspcious script
      or executable as system files to hide them from users and make them unable to
      delete with simple rights. The rule limit the search to sepcific extensions
      and directories to avoid FP's
    falsepositives:
    - Unknown
    level: high
    references:
    - https://app.any.run/tasks/c28cabc8-a19f-40f3-a78b-cae506a5c0d4
    - https://app.any.run/tasks/cfc8870b-ccd7-4210-88cf-a8087476a6d0
    tags:
    - attack.defense_evasion
    - attack.t1564.001
  name: Set Suspicious Files as System Files Using Attrib

