detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \sc.exe
      - case sensitive: false
        op: is
        path: event/ORIGINAL_FILE_NAME
        value: sc.exe
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: ' delete '
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: AvgAdminServer
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: AVG Antivirus
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: MBEndpointAgent
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: MBAMService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: MBCloudEA
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: avgAdminClient
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SAVService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SAVAdminService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos AutoUpdate Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos Clean Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos Device Control Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos File Scanner Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos Health Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos MCS Agent
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos MCS Client
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SntpService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: swc_service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: swi_service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos UI
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: swi_update
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos Web Control Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos System Protection Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos Safestore Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: hmpalertsvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: RpcEptMapper
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Sophos Endpoint Defense Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SophosFIM
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: swi_filter
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: FirebirdGuardianDefaultInstance
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: FirebirdServerDefaultInstance
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: WRSVC
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ekrn
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ekrnEpsw
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: klim6
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: AVP18.0.0
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: KLIF
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: klpd
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: klflt
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: klbackupdisk
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: klbackupflt
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: klkbdflt
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: klmouflt
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: klhk
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: KSDE1.0.0
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: kltap
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ScSecSvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Core Mail Protection
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Core Scanning Server
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Core Scanning ServerEx
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Online Protection System
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: RepairService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Core Browsing Protection
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Quick Update Service
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: McAfeeFramework
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: macmnsvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: masvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: mfemms
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: mfevtp
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: TmFilter
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: TMLWCSService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: tmusa
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: TmPreFilter
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: TMSmartRelayService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: TMiCRCScanService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: VSApiNt
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: TmCCSF
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: tmlisten
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: TmProxy
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ntrtscan
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ofcservice
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: TmPfw
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: PccNTUpd
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: PandaAetherAgent
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: PSUAService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: NanoServiceMain
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: EPIntegrationService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: EPProtectedService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: EPRedline
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: EPSecurityService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: EPUpdateService
respond:
- action: report
  metadata:
    author: Nasreddine Bencherchali
    description: Detects when attackers use "sc.exe" to delete AV services from the
      system in order to avoid detection
    falsepositives:
    - Legitimate software deleting using the same method of deletion (Add it to a
      filter if you find cases as such)
    level: high
    references:
    - https://www.virustotal.com/gui/file/38283b775552da8981452941ea74191aa0d203edd3f61fb2dee7b0aea3514955
    tags:
    - attack.execution
    - attack.defense_evasion
    - attack.t1562.001
  name: Suspicious Execution of Sc to Delete AV Services

