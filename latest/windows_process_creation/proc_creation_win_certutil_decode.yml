detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \certutil.exe
      - case sensitive: false
        op: is
        path: event/ORIGINAL_FILE_NAME
        value: CertUtil.exe
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: '-decode '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: '/decode '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: '-decodehex '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: '/decodehex '
respond:
- action: report
  metadata:
    author: Florian Roth (Nextron Systems), Jonhnathan Ribeiro, oscd.community
    description: Detects the execution of certutil with either the "decode" or "decodehex"
      flags to decode base64 or hex encoded files. This can be abused by attackers
      to decode an encoded payload before execution
    falsepositives:
    - Unknown
    level: medium
    references:
    - https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil
    - https://unit42.paloaltonetworks.com/new-babyshark-malware-targets-u-s-national-security-think-tanks/
    - https://news.sophos.com/en-us/2021/04/13/compromised-exchange-server-hosting-cryptojacker-targeting-other-exchange-servers/
    - https://twitter.com/JohnLaTwC/status/835149808817991680
    - https://learn.microsoft.com/en-us/archive/blogs/pki/basic-crl-checking-with-certutil
    - https://lolbas-project.github.io/lolbas/Binaries/Certutil/
    tags:
    - attack.defense_evasion
    - attack.t1027
  name: File Decoded From Base64/Hex Via Certutil.EXE

