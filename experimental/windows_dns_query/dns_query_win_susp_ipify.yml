detect:
  event: DNS_REQUEST
  op: and
  rules:
  - op: or
    rules:
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: canireachthe.net
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: ipv4.icanhazip.com
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: ip.anysrc.net
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: edns.ip-api.com
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: wtfismyip.com
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: checkip.dyndns.org
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: api.2ip.ua
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: icanhazip.com
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: api.ipify.org
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: ip-api.com
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: checkip.amazonaws.com
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: ipecho.net
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: ipinfo.io
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: ipv4bot.whatismyipaddress.com
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: freegeoip.app
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: ifconfig.me
    - case sensitive: false
      op: is
      path: event/DOMAIN_NAME
      value: ipwho.is
  - not: true
    op: or
    rules:
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \Google\Chrome\Application\chrome.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \iexplore.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \firefox.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \brave.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \opera.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \msedge.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \vivaldi.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \chromium.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \microsoftedge.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \iexplorer.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \CCleaner Browser\Application\CCleanerBrowser.exe
respond:
- action: report
  metadata:
    author: Brandon George (blog post), Thomas Patzke (rule)
    description: Detects DNS queries for ip lookup services such as api.ipify.org
      not originating from a non browser process.
    falsepositives:
    - Legitimate usage of ip lookup services such as ipify API
    level: medium
    references:
    - https://www.binarydefense.com/analysis-of-hancitor-when-boring-begets-beacon
    - https://twitter.com/neonprimetime/status/1436376497980428318
    tags:
    - attack.reconnaissance
    - attack.t1590
  name: Suspicious DNS Query for IP Lookup Service APIs

